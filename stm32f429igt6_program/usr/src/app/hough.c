#include <stdlib.h>
#include "matrix.h"
#include <math.h>
#include "hough.h"
int hough(_matrix_pt mat)
 {
     int iRMax = (int)sqrt((mat->row*mat->row) + (mat->col * mat->col));
     int iThMax = 181;
     int iTh = 0;
     int iR = 0;
     float iRT=0;
     int iMax = -1;
     int iThMaxIndex = -1;
     short uc_sin[181]=
     {
            0,175,349,523,698,872,1045,1219,
            1391,1564,1736,1908,2079,2250,2419,
            2588,2756,2924,3090,3256,3420,3584,
            3746,3907,4067,4226,4384,4540,4695,
            4848,5000,5150,5299,5446,5591,5736,
            5878,6018,6157,6293,6428,6561,6691,
            6820,6947,7071,7193,7314,7431,7547,
            7660,7771,7880,7986,8090,8192,8290,
            8387,8480,8572,8660,8746,8829,8910,
            8988,9063,9135,9205,9272,9336,9397,
            9455,9511,9563,9613,9659,9703,9744,
            9781,9816,9848,9877,9903,9925,9945,
            9962,9976,9986,9994,9998,10000,9998,
            9994,9986,9976,9962,9945,9925,9903,
            9877,9848,9816,9781,9744,9703,9659,
            9613,9563,9511,9455,9397,9336,9272,
            9205,9135,9063,8988,8910,8829,8746,
            8660,8572,8480,8387,8290,8192,8090,
            7986,7880,7771,7660,7547,7431,7314,
            7193,7071,6947,6820,6691,6561,6428,
            6293,6157,6018,5878,5736,5591,5446,
            5299,5150,5000,4848,4695,4540,4384,
            4226,4067,3907,3746,3584,3420,3256,
            3090,2924,2756,2588,2419,2250,2079,
            1908,1736,1564,1391,1219,1045,872,
            698,523,349,175,0,
    };
     
    short uc_cos[181]=
    {
        10000,9998,9994,9986,9976,9962,9945,9925,9903,9877,
        9848,9816,9781,9744,9703,9659,9613,9563,9511,9455,
        9397,9336,9272,9205,9135,9063,8988,8910,8829,8746,
        8660,8572,8480,8387,8290,8192,8090,7986,7880,7771,
        7660,7547,7431,7314,7193,7071,6947,6820,6691,6561,
        6428,6293,6157,6018,5878,5736,5591,5446,5299,5150,
        5000,4848,4695,4540,4384,4226,4067,3907,3746,3584,
        3420,3256,3090,2924,2756,2588,2419,2250,2079,1908,
        1736,1564,1391,1219,1045,872,698,523,349,175,0,
        -175,-349,-523,-698,-872,-1045,-1219,-1391,-1564,
        -1736,-1908,-2079,-2250,-2419,-2588,-2756,-2924,
        -3090,-3256,-3420,-3584,-3746,-3907,4067,-4226,
        -4384,-4540,-4695,-4848,-5000,-5150,-5299,-5446,
        -5591,-5736,-5878,-6018,-6157,-6293,-6428,-6561,
        -6691,-6820,-6947,-7071,-7193,-7314,-7431,-7547,
        -7660,-7771,-7880,-7986,-8090,-8192,-8290,-8387,
        -8480,-8572,-8660,-8746,-8829,-8910,-8988,-9063,
        -9135,-9205,-9272,-9336,-9397,-9455,-9511,-9563,
        -9613,-9659,-9703,-9744,-9781,-9816,-9848,-9877,
        -9903,-9925,-9945,-9962,-9976,-9986,-9994,-9998,
        -10000,
    };

    // int iRMaxIndex = -1;
     _matrix_pt pArray=matrix_create(iRMax,iThMax);
     int y=0;
     int x=0;
     //int k=0;
     int row=mat->row;
     int col=mat->col;
     //matrix_disp(mat);
     for (x = 0; x <iRMax; x++)
     {
         for (y = 0; y< iThMax; y++)
         {
             VALUE(pArray,x,y)=0;
         }
     }
     for (x = 0; x < row; x++)
     {
         for (y = 0; y < col; y++)
         {
             if(VALUE(mat,x,y)==0)
             {
                 for(iTh = 0; iTh < iThMax; iTh++)
                 {
                     iRT = x * uc_cos[iTh]/10000 + y * uc_sin[iTh]/10000;
                     iR = (int)(iRT+0.5f);

                     if(iR > 0)
                     {
                         VALUE(pArray,iR,iTh)=VALUE(pArray,iR,iTh)+1;
                         //k=k+1;
                     }
                 }
             }
         }
     }
     //DISP("%d\n",k);
     //matrix_disp(pArray);

     for(iR = 0; iR < iRMax; iR++)
     {
         for(iTh = 0; iTh < iThMax; iTh++)
         {
             int iCount = VALUE(pArray,iR,iTh);
             if(iCount > iMax)
             {
                 iMax = iCount;
                // iRMaxIndex = iR;
                 iThMaxIndex = iTh;
             }
         }
     }
     free(pArray);
     return iThMaxIndex;

 }
